name: Pipeline

on:
  pull_request:
  push:
    branches: [main, master]
  schedule:
    - cron: "0 5 * * *" # nightly quality
    - cron: "0 3 * * 0" # weekly soak
    - cron: "0 6 * * 0" # fuzz corpus maintenance
  workflow_dispatch:
    inputs:
      run:
        description: "Which pipeline slice to run"
        required: false
        default: "ci"
        type: choice
        options:
          - ci
          - docs
          - nightly
          - weekly-soak
          - fuzz-corpus
          - full

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pipeline-${{ github.ref }}-${{ github.event_name }}-${{ github.event.schedule || github.event.inputs.run || 'default' }}
  cancel-in-progress: false

jobs:
  ci-release-readiness:
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.run == 'ci' || github.event.inputs.run == 'full'))
    runs-on: ubuntu-latest
    timeout-minutes: 240
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install nightly toolchain
        run: rustup toolchain install nightly
      - uses: Swatinem/rust-cache@v2
      - name: Install dependencies
        run: |
          cargo install cargo-fuzz
          sudo apt-get update
          sudo apt-get install -y jq
      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov
      - name: Run workspace tests
        run: cargo test --workspace -- --nocapture
      - name: Run release readiness gate
        env:
          ENTDB_SKIP_WORKSPACE_TESTS: "1"
          PERF_BASELINE_PROFILE: ci
        run: ./scripts/release_readiness.sh

  docs-pages-build:
    if: |
      (github.event_name == 'push' && github.ref_name == 'main') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.run == 'docs' || github.event.inputs.run == 'full'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install mdBook
        run: cargo install mdbook --locked
      - name: Build docs
        working-directory: docs-site
        run: mdbook build
      - name: Setup Pages
        uses: actions/configure-pages@v5
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs-site/book

  docs-pages-deploy:
    if: |
      (github.event_name == 'push' && github.ref_name == 'main') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.run == 'docs' || github.event.inputs.run == 'full'))
    needs: docs-pages-build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  nightly-quality:
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 5 * * *') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.run == 'nightly' || github.event.inputs.run == 'full'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Run stress suites
        run: |
          cargo stress
          cargo stress-wal
      - name: Run soak SLO gate
        env:
          ENTDB_STRESS_SOAK_SECS: 1800
          ENTDB_MVCC_STRESS_SECS: 1800
          ENTDB_WAL_STRESS_TXNS: 15000
          ENTDB_SOAK_MAX_WALL_SECS: 4200
        run: ./scripts/soak_slo_gate.sh
      - name: Run perf regression suites
        run: ./scripts/perf_regression_gate.sh
      - name: Record perf history entry
        run: ./scripts/perf_history_record.sh
      - name: Upload perf history artifact
        uses: actions/upload-artifact@v4
        with:
          name: perf-history
          path: perf/history/perf_history.jsonl
      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov
      - name: Record coverage history entry
        run: ./scripts/coverage_history_record.sh
      - name: Upload coverage history artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-history
          path: coverage/history/coverage_history.jsonl

  weekly-soak:
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 3 * * 0') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.run == 'weekly-soak' || github.event.inputs.run == 'full'))
    runs-on: ubuntu-latest
    timeout-minutes: 370
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Run long soak gate
        env:
          ENTDB_STRESS_SOAK_SECS: 7200
          ENTDB_MVCC_STRESS_SECS: 7200
          ENTDB_WAL_STRESS_TXNS: 20000
          ENTDB_SOAK_MAX_WALL_SECS: 15000
        run: ./scripts/soak_slo_gate.sh

  fuzz-corpus-maintenance:
    if: |
      (github.event_name == 'schedule' && github.event.schedule == '0 6 * * 0') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.run == 'fuzz-corpus' || github.event.inputs.run == 'full'))
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz
      - name: Refresh fuzz corpus
        run: ./scripts/fuzz_corpus_ingest.sh
